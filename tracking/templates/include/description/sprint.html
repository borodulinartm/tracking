{% extends 'include/base.html' %}
{% load static %}

{% block title %}
    <div class="title_block">
        <h2 class="title">{{ title_page }}</h2>
    </div>
{% endblock title %}

{% block content %}
    <div class="list_button_block">
        {% for content_list in table %}
            <div class="row">
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <span class="fw-bolder text_button">Номер:</span>
                                <span class="fw-normal text_button">{{ content_list.sprint_id }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <span class="fw-bolder text_button">Код:</span>
                                <span class="fw-normal text_button">{{ content_list.code }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <span class="fw-bolder text_button">Название:</span>
                                <span class="fw-normal text_button">{{ content_list.name }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <span class="fw-bolder text_button">Создано:</span>
                                <span class="fw-normal text_button">{{ content_list.date_create }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <span class="fw-bolder text_button">Дата начала:</span>
                                <span class="fw-normal text_button">{{ content_list.date_start }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <span class="fw-bolder text_button">Дата завершения:</span>
                                <span class="fw-normal text_button">{{ content_list.date_end }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <span class="fw-bolder text_button">Описание:</span>
                                <span class="fw-normal text_button">{{ content_list.description }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <a href="{% url 'sprint_edit' project_id=content_list.project_id sprint_id=content_list.sprint_id %}?next={{ request.path|urlencode }}"
                                   class="btn btn-primary text_button"> Редактировать
                                </a>

                                <a type="button" data-bs-toggle="modal" data-bs-target="#exampleModal" href="#"
                                   class="btn btn-danger text_button"> Удалить
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Remove modal window -->
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Внимание</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text_button">Вы действительно хотите удалить спринт?</div>
                        <div class="modal-footer">
                            <a type="button" class="btn btn-primary" data-bs-dismiss="modal">Отмена</a>
                            <a type="button"
                               href="{% url 'sprint_remove' project_id=project_id sprint_id=content_list.sprint_id %}"
                               class="btn btn-danger">Подтвердить удаление</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="position_block justify-content-between">
                <div class="row">
                    <div class="col-sm">
                        <div class="d-flex justify-content-center">
                            <div class="row w-100">
                                <div class="position_block">
                                    <div class="d-flex justify-content-between">
                                        <a href="{% url 'report_laboriousness' project_id=project_id sprint_id=sprint_id %}"
                                           class="list-group-item list-group-item-action text_button"
                                           aria-current="true">
                                            <div class="d-flex w-75 justify-content-between">
                                                <h3 class="mb-1">
                                                    Отчёт по нагруженности сотрудников
                                                    <span class="fw-normal">
                                                        <img src="{% static 'img/angle-right.svg' %}" alt="Right"
                                                             rel="icon">
                                                    </span>
                                                </h3>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="block_title" style="margin-top: 50px">
                <h2 class="title">Задачи спринта</h2>
            </div>

            <div class="row">
                <div class="col-sm">
                    <div class="d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="position_block">
                                <a href="#" class="btn btn-primary text_button" data-bs-toggle="modal"
                                   data-bs-target="#exampleModal1">Добавить задачу
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel1"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel1">Добавление задачи</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close">
                            </button>
                        </div>
                        <div class="modal-body text_button">
                            <form action="{% url 'task_sprint_search' project_id=project_id sprint_id=content_list.sprint_id %}"
                                  class="form-inline" method="get">
                                <div class="form-group mx-sm-3 mb-2">
                                    <label for="" class="sr-only text_button"></label>
                                    <input name="search" class="form-control" id=""
                                           placeholder="Введите название задачи">
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg mb-2">Поиск</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="position_block" id="collapseExample_tasks"></div>

        {% endfor %}
    </div>
{% endblock content %}

{% block script %}
    <script>
        $.ajax({
            type: 'GET',
            url: '{% url 'list_tasks_for_sprint' project_id=project_id sprint_id=sprint_id %}',

            success: function (response) {
                let data = response.data;

                let selector = document.getElementById("collapseExample_tasks")
                selector.innerHTML = "";

                let temp = `
                <table class="table table-bordered">
                    <tr>
                        <th class="text_button fw-bold">Код</th>
                        <th class="text_button fw-bold">Название</th>
                        <th class="text_button fw-bold">Состояние</th>
                        <th class="text_button fw-bold">Ответственный</th>`

                if (response.is_staff) {
                    temp += `<th class="text_button"></th>`
                }

                temp += '</tr>'

                let i = 0;
                data.forEach(element => {
                    let id = "exampleModalEditing" + i;

                    let link = `/main_page/projects/{{ project_id }}/sprints/{{ sprint_id }}/delete_task/${element.task_id}`
                    let link_to_task = `/main_page/projects/{{ project_id }}/tasks/${element.task_id}`

                    temp += `
                        <tr>
                            <th class="text_button fw-normal">
                                    <a class="btn btn-outline-primary text_button" href="${link_to_task}">
                                        ${element.code}
                                    </a>
                            </th>
                            <th class="text_button fw-normal">${element.task_name}</th>
                            <th class="text_button fw-normal">${element.state_name}</th>
                            <th class="text_button fw-normal">${element.user_name}</th>
                    `
                    if (response.is_staff) {
                        temp += `
                            <th class="text_button">
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#` + id + `"
                                       class="btn btn-outline-danger text_button">Удалить задачу
                                    </a>
                            </th>
                            <div class="modal fade" id="` + id + `" tabindex="-1" aria-labelledby="exampleModalEditing"
                                    aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Внимание</h5>
                                            <a type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></a>
                                        </div>
                                        <div class="modal-body text_button">Вы действительно хотите удалить задачу?</div>
                                            <div class="modal-body text_button">Удаляемые данные: Код задачи - ${element.code}</div>
                                            <div class="modal-footer">
                                                <a type="button" class="btn btn-primary" data-bs-dismiss="modal">Отмена</a>
                                                <a type="button"
                                                    href="` + link + `"
                                                    class="btn btn-danger">Подтвердить удаление</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        `
                    }

                    temp += `</tr>`
                    i++;
                })

                temp += `</table>`
                $("#collapseExample_tasks").append(temp)
            }
        })
    </script>
{% endblock script %}