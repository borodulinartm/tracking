{% extends 'include/base.html' %}
{% load static %}

{% block config %}
    <!--Chart js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"
            integrity="sha256-Uv9BNBucvCPipKQ2NS9wYpJmi8DTOEfTA/nH2aoJALw=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css"
          integrity="sha256-aa0xaJgmK/X74WM224KMQeNQC2xYKwlAt08oZqjeF0E=" crossorigin="anonymous"/>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
{% endblock config %}

{% block content %}
    <div class="title_block">
        <h2 class="title">Диаграмма голосования за задачи</h2>
    </div>

    <div style="margin-bottom: 100px">
        <div class="position_block">
            <a class="float-end btn btn-outline-light"
               data-bs-toggle="modal"
               data-bs-target="#collapseExample_settings_votes">
                <img src="{% static 'img/settings-sliders.svg' %}" alt="settings" rel="icon">
            </a>
        </div>
        <canvas id="myChart" height="500%"></canvas>
    </div>

    <div class="title_block">
        <h2 class="title">Список задач</h2>
    </div>

    <div class="position_block" id="titles">
    </div>

    <div class="row w-100">
    </div>

    <div class="modal fade" id="collapseExample_settings_votes" tabindex="-1" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="exampleModalLabel">Выбор задачи</h4>
                    <a type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></a>
                </div>
                <div class="modal-body text_button">
                    <form class="form-inline search-form" method="get">
                        <div class="position_block form-check" style="margin-bottom: 10px">
                            <label for="task_all">Отметить все</label>
                            <input class="form-check-input"
                                   type="checkbox" id="task_all" onclick="checkbox_task_all_clicled()"
                                   checked>
                        </div>

                        <hr>
                        {% for task in list_tasks %}
                            <div class="position_block form-check" style="margin-bottom: 10px">
                                <label for="task_{{ task.code }}">{{ task.code|truncatechars:40 }}
                                    {{ task.name|truncatechars:30 }}</label>
                                <input class="form-check-input"
                                       type="checkbox" id="task_{{ task.code }}"
                                       onclick="checkbox_with_task_clicked()"
                                       checked>
                            </div>
                        {% endfor %}
                    </form>
                </div>

                <div class="modal-footer">
                    <a type="button" data-bs-dismiss="modal"
                       href="#"
                       onclick="insert_data()"
                       class="btn btn-primary">Подтвердить</a>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block script %}
    <script>
        let myChart = null;

        const filter_tasks = (array_with_task_id) => {
            $.ajax({
                type: 'GET',
                url: '{% url "get_list_votes_for_certain_tasks" project_id=project_id %}',
                data: {
                    'array_with_task_id': array_with_task_id
                }, success: function (response) {
                    const data = response.data;

                    const data_arr = [];
                    const label_arr = [];

                    data.forEach(element => {
                        data_arr.push(element.count_employee)
                        label_arr.push(element.code)
                    })

                    const color_arr = [];
                    const color = response.color;
                    data.forEach(elem => {
                        color_arr.push(color)
                    })

                    const ctx = document.getElementById('myChart').getContext('2d');
                    if (myChart !== null) {
                        myChart.destroy();
                    }

                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: label_arr,
                            datasets: [{
                                label: "Количество голосов",
                                backgroundColor: color_arr,
                                data: data_arr
                            }]
                        },
                        options: {
                            tooltips: {
                                displayColors: true,
                                callbacks: {
                                    mode: 'x',
                                },
                            },
                            scales: {
                                xAxes: [{
                                    stacked: true,
                                    gridLines: {
                                        display: false,
                                    }, ticks: {
                                        autoSkip: true,
                                        maxTicksLimit: 20
                                    }
                                }],
                                yAxes: [{
                                    stacked: true,
                                    ticks: {
                                        beginAtZero: true,
                                    },
                                    type: 'linear',
                                }]
                            },

                            responsive: true,
                            maintainAspectRatio: false,
                            legend: {position: 'top'},
                        }

                    });

                    document.getElementById("titles").innerHTML = ""

                    // Добавляем также данные
                    data.forEach(element => {
                        let link_to_the_task = `/main_page/projects/${response.project_id}/tasks/${element.id}`
                        let temp = `
                        <div class="d-flex justify-content-center">
                            <div class="row w-75">
                                <a href="${link_to_the_task}"
                                   class="list-group-item list-group-item-action text_button" aria-current="true">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h3 class="mb-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" id="Layer_1" data-name="Layer 1" viewBox="0 0 24 24" width="36" height="36">
                                                <path fill="${element.color}"
                                                     d="M24,18.586c0,1.068-.416,2.072-1.172,2.828l-1.414,1.414c-.755,.756-1.76,1.172-2.828,1.172s-2.073-.416-2.829-1.172l-2.69-2.69c-.391-.391-.391-1.023,0-1.414s1.023-.391,1.414,0l2.69,2.69c.756,.756,2.073,.756,2.829,0l1.414-1.414c.378-.378,.586-.88,.586-1.414s-.208-1.036-.586-1.414l-1.931-1.932-1.415,1.414c-.391,.391-1.023,.391-1.414,0s-.391-1.023,0-1.414l2.122-2.121c.391-.391,1.023-.391,1.414,0l2.638,2.639c.756,.755,1.172,1.759,1.172,2.828ZM3.862,10.933c.195,.195,.451,.293,.707,.293s.512-.098,.707-.293c.391-.391,.391-1.023,0-1.414l-2.69-2.69c-.378-.378-.586-.88-.586-1.414s.208-1.036,.586-1.414l1.414-1.414c.756-.756,2.073-.756,2.829,0l1.932,1.932-1.415,1.414c-.391,.391-.391,1.023,0,1.414s1.023,.391,1.414,0l2.122-2.121c.188-.188,.293-.441,.293-.707s-.105-.52-.293-.707l-2.639-2.639C6.732-.34,4.097-.34,2.586,1.172l-1.414,1.414c-.756,.756-1.172,1.76-1.172,2.828s.416,2.073,1.172,2.828l2.69,2.69ZM22.925,6.269L6.95,22.242c-1.132,1.134-2.639,1.758-4.242,1.758H1c-.552,0-1-.447-1-1v-1.708c0-1.603,.624-3.109,1.757-4.242L17.731,1.075c1.431-1.431,3.761-1.433,5.193,0,1.431,1.432,1.431,3.762,0,5.193Zm-5.2,2.371l-2.365-2.365L3.171,18.464c-.755,.756-1.171,1.76-1.171,2.828v.708h.708c1.069,0,2.073-.416,2.828-1.172l12.19-12.189Zm3.785-6.15c-.652-.652-1.712-.651-2.365,0l-2.371,2.371,2.365,2.365,2.371-2.371c.651-.652,.651-1.713,0-2.365Z"/>
                                            </svg>
                                            ${element.code}: ${element.name}
                                        </h3>
                                        <small>
                                            <img src="{% static 'img/heart.svg' %}" alt="heart" rel="icon">
                                            ${element.count_employee}
                                        </small>
                                    </div>
                                    <p class="mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" id="Outline" viewBox="0 0 24 24" width="24"
                                                 height="24">
                                        <path
                                              d="M12,0A12,12,0,1,0,24,12,12.013,12.013,0,0,0,12,0Zm0,22A10,10,0,1,1,22,12,10.011,10.011,0,0,1,12,22Z"></path>
                                        <path d="M12,10H11a1,1,0,0,0,0,2h1v6a1,1,0,0,0,2,0V12A2,2,0,0,0,12,10Z"
                                              >
                                        </path>
                                        <circle cx="12" cy="6.5" r="1.5"></circle>
                                    </svg>
                                    `
                        if (element.description.length > 50) {
                            temp += `${element.description.slice(0, 50)}`
                        } else {
                            temp += `${element.description}`
                        }
                        temp += `</p>
                                </a>
                            </div>
                        </div>
                    `
                        $("#titles").append(temp)
                    })
                }, error: function (error) {
                    console.log(error)
                }
            })
        }

        function insert_data() {
            const array_checked_checkboxes = [];

            let elem;
            {% for task in list_tasks %}
                elem = document.getElementById("task_{{ task.code }}")
                console.log(elem.checked)
                if (elem.checked) {
                    array_checked_checkboxes.push("{{ task.task_id }}")
                }
            {% endfor %}

            scroll(0,0)

            if (array_checked_checkboxes.length > 0) {
                filter_tasks(array_checked_checkboxes.toString())
            } else {
                filter_tasks('-1')
            }
        }

        function change_all_checkboxes(state) {
            let elem;
            {% for task in list_tasks %}
            elem = document.getElementById("task_{{ task.code }}")
            elem.checked = state;
            {% endfor %}
        }

        function checkbox_task_all_clicled() {
            var data = document.getElementById("task_all")

            if (data.checked) {
                change_all_checkboxes(true)
            } else {
                change_all_checkboxes(false);
            }
        }

        const checkBoxesState = {
            "disable": 0,
            "enable": 1,
            "indeterminate": 2
        }

        function getStateOfCheckBoxes() {
            let hasCheckedCheckbox = false;
            let hasUnCheckedCheckbox = false;

            let elem;
            {% for task in list_tasks %}
            elem = document.getElementById("task_{{ task.code }}")
            if (elem.checked) {
                hasCheckedCheckbox = true;
            } else {
                hasUnCheckedCheckbox = true;
            }
            {% endfor %}

            if (hasUnCheckedCheckbox && hasUnCheckedCheckbox) {
                return checkBoxesState.indeterminate;
            } else if (!hasUnCheckedCheckbox) {
                return checkBoxesState.enable;
            } else if (!hasCheckedCheckbox) {
                return checkBoxesState.disable;
            }
        }

        // Данная функция изменяет состояние верхнего чек-бокса, если были изменены остальные
        function checkbox_with_task_clicked() {
            // Получаем текущее состояние всех чек-боксов
            let state = getStateOfCheckBoxes();

            const data = document.getElementById("task_all");
            // Заранее был создан enum с перечислением всех возможных типов
            if (state === checkBoxesState.disable) {
                // Третье состояние - неопределенно
                data.indeterminate = false;
                data.checked = false;
            } else if (state === checkBoxesState.indeterminate) {
                data.indeterminate = true;
            } else {
                data.indeterminate = false;
                data.checked = true;
            }
        }

        filter_tasks('')
    </script>
{% endblock script %}